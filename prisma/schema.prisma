generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////
// ENUMS
//////////////////////

enum AuthProvider {
  CREDENTIALS
  GOOGLE
}

enum UserStatus {
  ACTIVE
  SUSPENDED
}

enum TutorStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum BookingStatus {
  REQUESTED // student booked
  REJECTED // tutor rejected
  PAYMENT_PENDING // tutor accepted, waiting for payment
  PARTIALLY_PAID // 50% paid
  FULLY_PAID // 100% paid
  CONFIRMED // session unlocked
  COMPLETED
  CANCELLED
  READY
  EXPIRED
}

enum PayMode {
  HALF
  FULL
}

enum SessionType {
  ONE_TO_ONE
  GROUP
}

enum AvailabilityType {
  ONE_TO_ONE
  GROUP
}

enum PackageType {
  SINGLE_SESSION
  MONTHLY_PACKAGE
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum NotificationType {
  BOOKING_REQUESTED
  BOOKING_ACCEPTED
  BOOKING_REJECTED

  PAYMENT_REQUIRED
  PAYMENT_CONFIRMED
  PAYMENT_FAILED

  SESSION_SCHEDULED
  SESSION_LINK_SHARED
  SESSION_REMINDER
  SESSION_CANCELLED
  SESSION_RESCHEDULED
  SESSION_COMPLETED

  MESSAGE_RECEIVED
  SYSTEM_ANNOUNCEMENT
}

enum PaymentStatus {
  PENDING
  HALF_PAID
  FULL_PAID
  FAILED
}

enum BookingPaymentStatus {
  UNPAID
  PARTIALLY_PAID
  FULLY_PAID
}

enum PaymentGateway {
  ESEWA
  KHALTI
}

enum ConversationType {
  TUTOR_SESSION
  THRIFT
}

//////////////////////
// USER
//////////////////////

model User {
  id            String       @id @default(cuid())
  name          String?
  email         String       @unique
  password      String?
  phone         String?
  grade         String?
  image         String?
  emailVerified DateTime?
  verifyToken   String?
  authProvider  AuthProvider @default(CREDENTIALS)
  status        UserStatus   @default(ACTIVE)

  //  FORGOT PASSWORD
  resetToken   String?
  resetExpires DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accounts      Account[]
  sessions      Session[]
  thriftItems   ThriftItem[]
  reviews       Review[]
  bookings      Booking[]
  notifications Notification[]
  sentMessages Message[] @relation("UserMessages")
  conversations Conversation[] @relation("StudentConvos")
  conversationsThrift Conversation[] @relation("ThriftUserConvos")

}

//////////////////////
// TUTOR
//////////////////////

model Tutor {
  id       String @id @default(cuid())
  name     String
  email    String @unique
  phone    String
  password String

  photo      String?
  bio        String?
  subjects   String[]
  experience String?
  cvUrl      String?
  idUrl      String?
  rate       Int?

  status TutorStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  reviews        Review[]
  bookings       Booking[]
  availabilities TutorAvailability[]
  sentMessages Message[] @relation("TutorMessages")
  conversations Conversation[] @relation("TutorConvos")



}

//////////////////////
// TUTOR AVAILABILITY
//////////////////////
model TutorAvailability {
  id      String @id @default(cuid())
  tutorId String

  subject String
  level   String?

  date        DateTime
  startTime   String
  endTime     String
  durationMin Int

  sessionType AvailabilityType
  maxStudents Int?
  isActive    Boolean          @default(true)

  tutor    Tutor     @relation(fields: [tutorId], references: [id], onDelete: Cascade)
  bookings Booking[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//////////////////////
// BOOKINGS
//////////////////////

model Booking {
  id String @id @default(cuid())

  studentId      String
  tutorId        String
  availabilityId String

  student      User              @relation(fields: [studentId], references: [id], onDelete: Cascade)
  tutor        Tutor             @relation(fields: [tutorId], references: [id], onDelete: Cascade)
  availability TutorAvailability @relation(fields: [availabilityId], references: [id], onDelete: Cascade)

  sessionType SessionType
  subject     String
  level       String?

  bookingDate DateTime
  startTime   DateTime
  endTime     DateTime
  durationMin Int

  maxStudents  Int?
  currentCount Int  @default(1)

  packageType   PackageType @default(SINGLE_SESSION)
  packageMonths Int?

  hourlyRate  Int
  totalAmount Int

  note          String?
  notifications Notification[]

  status BookingStatus @default(REQUESTED)

  payments      Payment[]
  paymentStatus BookingPaymentStatus @default(UNPAID)

  meetingRoom    String?
  sessionStarted Boolean       @default(false)
  startedAt      DateTime?
  endedAt        DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tutorId, startTime, endTime])
}

//////////////////////
// PAYMENT
//////////////////////
model Payment {
  id String @id @default(cuid())

  bookingId String
  booking   Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  gateway         PaymentGateway
  transactionUuid String         @unique
  amount          Int
  payMode         PayMode

  paidAmount Int

  status PaymentStatus @default(PENDING)

  refId       String?
  rawResponse Json?

  adminCommission Int?
  tutorEarning    Int?
  tutorPaid       Boolean   @default(false)
  tutorPaidAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([bookingId])
}

//////////////////////
// REVIEWS
//////////////////////

model Review {
  id      String @id @default(cuid())
  rating  Int
  comment String

  tutorId String
  userId  String

  tutor Tutor @relation(fields: [tutorId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tutorId, userId])
}

//////////////////////
// THRIFT ITEMS
//////////////////////

model ThriftItem {
  id        String  @id @default(cuid())
  title     String
  subject   String?
  condition String?
  price     Int
  contact   String
  image     String?
  grade     String?

  isSold    Boolean @default(false)   // üëà ADD THIS
  isActive  Boolean @default(true)    // üëà OPTIONAL (better than delete)

  sellerId String
  seller   User   @relation(fields: [sellerId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([isSold])
  @@index([isActive])
}


//////////////////////
// NEXTAUTH
//////////////////////

model Account {
  id                String @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String

  refresh_token      String?
  access_token       String?
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?
  session_state      String?
  oauth_token_secret String?
  oauth_token        String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Notification {
  id String @id @default(cuid())

  // Owner (ONE of these)
  userId  String? // Student
  tutorId String? // Tutor

    // ‚≠ê NEW
  isForAdmin Boolean @default(false)
  adminCategory String? // REGISTER / PAYMENT / SESSION / SYSTEM

  // Core content
  title   String
  message String
  type    NotificationType

  // Optional references
  bookingId String?
  sessionId String?
  studentId String?

  // Action handling
  actionUrl   String?
  actionLabel String?

  // Read status
  isRead Boolean @default(false)



  // Timestamp
  createdAt DateTime @default(now())

  // Relations
  user    User?    @relation(fields: [userId], references: [id])
  booking Booking? @relation(fields: [bookingId], references: [id])

  @@index([userId])
  @@index([tutorId])
   @@index([isForAdmin])
}

//////////////////////
// MESSAGE
//////////////////////

model Conversation {
  id String @id @default(cuid())

  // common
  studentId String
  student   User @relation("StudentConvos", fields: [studentId], references: [id])

  type ConversationType

  // tutor chat
  tutorId String?
  tutor   Tutor? @relation("TutorConvos", fields: [tutorId], references: [id])

  // thrift chat
  thriftUserId String?
  thriftUser   User? @relation("ThriftUserConvos", fields: [thriftUserId], references: [id])

  thriftItemId String?

  messages Message[]

  createdAt DateTime @default(now())

  // IMPORTANT UNIQUES
  @@unique([studentId, tutorId], map: "unique_tutor_chat")
  @@unique([studentId, thriftUserId, thriftItemId], map: "unique_thrift_chat")
}



model Message {
  id             String       @id @default(cuid())

  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  // sender can be student OR tutor
  senderUserId  String?
  senderTutorId String?

  senderUser  User?  @relation("UserMessages", fields: [senderUserId], references: [id], onDelete: Cascade)
  senderTutor Tutor? @relation("TutorMessages", fields: [senderTutorId], references: [id], onDelete: Cascade)

  content   String
  isRead    Boolean  @default(false)

  createdAt DateTime @default(now())
}



//////////////////////
// ADMIN
//////////////////////

model Admin {
  id       String @id @default(cuid())
  email    String @unique
  password String
  role     String @default("ADMIN")
}
