generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////
// ENUMS
//////////////////////

enum TutorStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum BookingStatus {
  REQUESTED
  ACCEPTED
  REJECTED
  PAYMENT_PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
}

enum SessionType {
  ONE_TO_ONE
  GROUP
}

enum AvailabilityType {
  ONE_TO_ONE
  GROUP
}

enum PackageType {
  SINGLE_SESSION
  MONTHLY_PACKAGE
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

//////////////////////
// USER
//////////////////////

model User {
  id            String   @id @default(cuid())
  name          String?
  email         String   @unique
  password      String?
  phone         String?
  grade         String?
  image         String?
  emailVerified DateTime?
  verifyToken   String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  accounts      Account[]
  sessions      Session[]
  thriftItems   ThriftItem[]
  reviews       Review[]
  bookings      Booking[]
}

//////////////////////
// TUTOR
//////////////////////

model Tutor {
  id           String   @id @default(cuid())
  name         String
  email        String   @unique
  phone        String
  password     String

  photo        String?
  bio          String?
  subjects     String[]
  experience   String?
  cvUrl        String?
  idUrl        String?
  rate         Int?

  status       TutorStatus @default(PENDING)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  reviews        Review[]
  bookings       Booking[]
  availabilities TutorAvailability[]
}

//////////////////////
// TUTOR AVAILABILITY
//////////////////////

model TutorAvailability {
  id           String           @id @default(cuid())
  tutorId      String

  dayOfWeek    DayOfWeek
  startTime    String           // HH:MM
  endTime      String           // HH:MM
  durationMin  Int

  sessionType  AvailabilityType
  maxStudents  Int?

  isActive     Boolean          @default(true)

  tutor        Tutor            @relation(fields: [tutorId], references: [id], onDelete: Cascade)
  bookings     Booking[]

  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  @@unique([tutorId, dayOfWeek, startTime, endTime, sessionType])
}

//////////////////////
// BOOKINGS
//////////////////////

model Booking {
  id              String        @id @default(cuid())

  studentId       String
  tutorId         String
  availabilityId  String

  student         User          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  tutor           Tutor         @relation(fields: [tutorId], references: [id], onDelete: Cascade)
  availability    TutorAvailability @relation(fields: [availabilityId], references: [id], onDelete: Cascade)

  sessionType     SessionType
  subject         String
  level           String?

  bookingDate     DateTime
  startTime       DateTime
  endTime         DateTime
  durationMin     Int

  maxStudents     Int?
  currentCount    Int           @default(1)

  packageType     PackageType   @default(SINGLE_SESSION)
  packageMonths   Int?

  hourlyRate      Int
  totalAmount     Int

  note            String?

  status          BookingStatus @default(REQUESTED)

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([tutorId, startTime, endTime])
}

//////////////////////
// REVIEWS
//////////////////////

model Review {
  id        String   @id @default(cuid())
  rating    Int
  comment   String

  tutorId   String
  userId    String

  tutor     Tutor    @relation(fields: [tutorId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tutorId, userId])
}

//////////////////////
// THRIFT ITEMS
//////////////////////

model ThriftItem {
  id        String   @id @default(cuid())
  title     String
  subject   String?
  condition String?
  price     Int
  contact   String
  image     String?
  grade     String?

  sellerId  String
  seller    User     @relation(fields: [sellerId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

//////////////////////
// NEXTAUTH
//////////////////////

model Account {
  id                String @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String

  refresh_token      String?
  access_token       String?
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?
  session_state      String?
  oauth_token_secret String?
  oauth_token        String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

//////////////////////
// ADMIN
//////////////////////

model Admin {
  id       String   @id @default(cuid())
  email    String   @unique
  password String
  role     String   @default("ADMIN")
}
