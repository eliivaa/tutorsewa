generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////
// ENUMS
//////////////////////

enum TutorStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum BookingStatus {
  REQUESTED
  ACCEPTED
  REJECTED
  PAYMENT_PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
}

enum SessionType {
  ONE_TO_ONE
  GROUP
}

enum AvailabilityType {
  ONE_TO_ONE
  GROUP
}

enum PackageType {
  SINGLE_SESSION
  MONTHLY_PACKAGE
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum NotificationType {
  BOOKING_REQUESTED
  BOOKING_ACCEPTED
  BOOKING_REJECTED

  PAYMENT_REQUIRED
  PAYMENT_CONFIRMED
  PAYMENT_FAILED

  SESSION_SCHEDULED
  SESSION_LINK_SHARED
  SESSION_REMINDER
  SESSION_CANCELLED
  SESSION_RESCHEDULED

  MESSAGE_RECEIVED
  SYSTEM_ANNOUNCEMENT
}

enum PaymentStatus {
  PENDING
  HALF_PAID
  FULL_PAID
  FAILED
}


enum BookingPaymentStatus {
  UNPAID
  PARTIALLY_PAID
  FULLY_PAID
}


enum PaymentGateway {
  ESEWA
  KHALTI
}

//////////////////////
// USER
//////////////////////

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  password      String?
  phone         String?
  grade         String?
  image         String?
  emailVerified DateTime?
  verifyToken   String?

  // üîê FORGOT PASSWORD
  resetToken   String?
  resetExpires DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accounts      Account[]
  sessions      Session[]
  thriftItems   ThriftItem[]
  reviews       Review[]
  bookings      Booking[]
  notifications Notification[]
}

//////////////////////
// TUTOR
//////////////////////

model Tutor {
  id       String @id @default(cuid())
  name     String
  email    String @unique
  phone    String
  password String

  photo      String?
  bio        String?
  subjects   String[]
  experience String?
  cvUrl      String?
  idUrl      String?
  rate       Int?

  status TutorStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  reviews        Review[]
  bookings       Booking[]
  availabilities TutorAvailability[]
}

//////////////////////
// TUTOR AVAILABILITY
//////////////////////
model TutorAvailability {
  id      String @id @default(cuid())
  tutorId String

  subject String
  level   String?

  date        DateTime
  startTime   String
  endTime     String
  durationMin Int

  sessionType AvailabilityType
  maxStudents Int?
  isActive    Boolean          @default(true)

  tutor    Tutor     @relation(fields: [tutorId], references: [id], onDelete: Cascade)
  bookings Booking[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//////////////////////
// BOOKINGS
//////////////////////

model Booking {
  id String @id @default(cuid())

  studentId      String
  tutorId        String
  availabilityId String

  student      User              @relation(fields: [studentId], references: [id], onDelete: Cascade)
  tutor        Tutor             @relation(fields: [tutorId], references: [id], onDelete: Cascade)
  availability TutorAvailability @relation(fields: [availabilityId], references: [id], onDelete: Cascade)

  sessionType SessionType
  subject     String
  level       String?

  bookingDate DateTime
  startTime   DateTime
  endTime     DateTime
  durationMin Int

  maxStudents  Int?
  currentCount Int  @default(1)

  packageType   PackageType @default(SINGLE_SESSION)
  packageMonths Int?

  hourlyRate  Int
  totalAmount Int

  note          String?
  notifications Notification[]

  status BookingStatus @default(REQUESTED)

  payments Payment[]
  paymentStatus   BookingPaymentStatus @default(UNPAID)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tutorId, startTime, endTime])
}

//////////////////////
// PAYMENT
//////////////////////
model Payment {
  id String @id @default(cuid())

  bookingId String
  booking   Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  gateway         PaymentGateway
  transactionUuid String         @unique // prevents reuse
  amount          Int

  payMode String // HALF or FULL
  status  PaymentStatus @default(PENDING)

  refId       String? // from eSewa verification
  rawResponse Json? // full gateway response (audit-safe)

  adminCommission Int?
  tutorEarning    Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([bookingId])
}

//////////////////////
// REVIEWS
//////////////////////

model Review {
  id      String @id @default(cuid())
  rating  Int
  comment String

  tutorId String
  userId  String

  tutor Tutor @relation(fields: [tutorId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tutorId, userId])
}

//////////////////////
// THRIFT ITEMS
//////////////////////

model ThriftItem {
  id        String  @id @default(cuid())
  title     String
  subject   String?
  condition String?
  price     Int
  contact   String
  image     String?
  grade     String?

  sellerId String
  seller   User   @relation(fields: [sellerId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

//////////////////////
// NEXTAUTH
//////////////////////

model Account {
  id                String @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String

  refresh_token      String?
  access_token       String?
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?
  session_state      String?
  oauth_token_secret String?
  oauth_token        String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Notification {
  id String @id @default(cuid())

  // Who receives this notification
  userId String

  // Core content
  title   String
  message String

  // Machine-readable type
  type NotificationType

  // üîó Optional references (VERY IMPORTANT)
  bookingId String?
  sessionId String?
  tutorId   String?
  studentId String?

  //Action handling
  actionUrl   String? // e.g. "/dashboard/payments/123"
  actionLabel String? // e.g. "Pay Now"

  // Read status
  isRead Boolean @default(false)

  // Timestamp
  createdAt DateTime @default(now())

  // Relations
  user    User     @relation(fields: [userId], references: [id])
  booking Booking? @relation(fields: [bookingId], references: [id])

  @@index([userId, isRead])
}

//////////////////////
// ADMIN
//////////////////////

model Admin {
  id       String @id @default(cuid())
  email    String @unique
  password String
  role     String @default("ADMIN")
}
